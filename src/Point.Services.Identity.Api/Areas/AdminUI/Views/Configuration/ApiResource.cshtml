@model ApiResourceDto
@inject IViewLocalizer Localizer

@{
	ViewBag.Title = Localizer["PageTitle"];
	Layout = "_Layout";
}

<div class="row">
	<div class="col-12">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-area="@CommonConsts.AdminUIArea" asp-controller="Configuration" asp-action="ApiResources">@Localizer["NavigationApiResources"]</a></li>
				<li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
			</ol>
		</nav>
	</div>

	<div class="col-12">
		<h2>@Localizer["PageTitle"]</h2>
	</div>
</div>

<form asp-area="@CommonConsts.AdminUIArea" asp-action="ApiResource" method="post" id="api-resource-form">

	<div asp-validation-summary="All" class="text-danger"></div>

	<!--Hidden -->
	<input type="hidden" asp-for="Id" />

	<div class="card mt-3">
		<h5 class="card-header">@Localizer["PanelTitle"]</h5>
		<div class="card-body">

			<!--Input - text -->
			<div class="form-group row">
				<label asp-for="Name" class="col-sm-3 col-form-label">
					@await Html.PartialAsync("ApiResource/Section/Label", "Name")
				</label>
				<div class="col-sm-9">
					<input type="text" required class="form-control" asp-for="Name">
					<span asp-validation-for="Name" class="text-danger"></span>
				</div>
			</div>

			<!--Input - text -->
			<div class="form-group row">
				<label asp-for="DisplayName" class="col-sm-3 col-form-label">
					@await Html.PartialAsync("ApiResource/Section/Label", "DisplayName")
				</label>
				<div class="col-sm-9">
					<input type="text" class="form-control" asp-for="DisplayName">
				</div>
			</div>

			<!--Input - text -->
			<div class="form-group row">
				<label asp-for="Description" class="col-sm-3 col-form-label">
					@await Html.PartialAsync("ApiResource/Section/Label", "Description")
				</label>
				<div class="col-sm-9">
					<input type="text" class="form-control" asp-for="Description">
				</div>
			</div>
			
            <!--Checkbox-->
            <div class="form-group row">
                <label asp-for="ShowInDiscoveryDocument" class="col-sm-3 col-form-label">
                    @await Html.PartialAsync("IdentityResource/Section/Label", "ShowInDiscoveryDocument")
                </label>
                <div class="col-sm-9">
                    <toggle-button>
                        <input asp-for="ShowInDiscoveryDocument" type="checkbox">
                    </toggle-button>
                </div>
            </div>

            <!--Checkbox-->
            <div class="form-group row">
                <label asp-for="Enabled" class="col-sm-3 col-form-label">
                    @await Html.PartialAsync("ApiResource/Section/Label", "Enabled")
                </label>
                <div class="col-sm-9">
                    <toggle-button>
                        <input asp-for="Enabled" type="checkbox">
                    </toggle-button>
                </div>
            </div>
			
			<!--Checkbox-->
			<div class="form-group row">
				<label asp-for="RequireResourceIndicator" class="col-sm-3 col-form-label">
					@await Html.PartialAsync("ApiResource/Section/Label", "RequireResourceIndicator")
				</label>
				<div class="col-sm-9">
					<toggle-button>
						<input asp-for="RequireResourceIndicator" type="checkbox">
					</toggle-button>
				</div>
			</div>

            @if (Model.Id != 0)
			{
				<!--Button-->
				<div class="form-group row">
					<label class="col-sm-3 col-form-label">
						@await Html.PartialAsync("ApiResource/Section/Label", "Secrets")
					</label>
					<div class="col-sm-9">
						<a asp-area="@CommonConsts.AdminUIArea" asp-action="ApiSecrets" asp-route-id="@Model.Id" class="btn btn-primary">@Localizer["ButtonManageSecrets"]</a>
					</div>
				</div>
				<!--Button-->
				<div class="form-group row">
					<label class="col-sm-3 col-form-label">
						@await Html.PartialAsync("ApiResource/Section/Label", "Properties")
					</label>
					<div class="col-sm-9">
						<a asp-area="@CommonConsts.AdminUIArea" asp-action="ApiResourceProperties" asp-route-id="@Model.Id" class="btn btn-primary">@Localizer["ButtonManageProperties"]</a>
					</div>
				</div>
			}
			
            <!--Select with tags-->
            <div class="form-group row">
                <label asp-for="AllowedAccessTokenSigningAlgorithms" class="col-sm-3 col-form-label">
                    @await Html.PartialAsync("ApiResource/Section/Label", "SigningAlgorithms")
                </label>
                <div class="col-sm-9">
                    <picker id="AllowedAccessTokenSigningAlgorithmsItems" multiple-select="true" min-search-text="2"
                            selected-items="@Model.AllowedAccessTokenSigningAlgorithms" url="@Url.Action("SearchSigningAlgorithms","Configuration")?algorithm"
                            search-input-placeholder="@Localizer["PickerSearchItemPlaceholder"].Value"
                            selected-items-title="@Localizer["PickerSelectedItemsTitle"].Value"
                            search-result-title="@Localizer["PickerSearchResultTitle"].Value"
                            suggested-items-title="@Localizer["PickerSuggestedItemsTitle"].Value"
                            no-item-selected-title="@Localizer["PickerNoItemSelectedTitle"].Value"
                            show-all-items-title="@Localizer["PickerShowAllItemsTitle"].Value"
                            item-already-selected-title="@Localizer["PickerItemAlreadySelectedTitle"].Value">
                    </picker>
                </div>
            </div>

            <!--Select with tags-->
            <div class="form-group row">
                <label asp-for="UserClaims" class="col-sm-3 col-form-label">
                    @await Html.PartialAsync("ApiResource/Section/Label", "UserClaims")
                </label>
                <div class="col-sm-9">
                    <picker id="UserClaimsItems" multiple-select="true" min-search-text="2"
                            selected-items="@Model.UserClaims" url="@Url.Action("SearchClaims","Configuration")?claim"
                            search-input-placeholder="@Localizer["PickerSearchItemPlaceholder"].Value"
                            selected-items-title="@Localizer["PickerSelectedItemsTitle"].Value"
                            search-result-title="@Localizer["PickerSearchResultTitle"].Value"
                            suggested-items-title="@Localizer["PickerSuggestedItemsTitle"].Value"
                            no-item-selected-title="@Localizer["PickerNoItemSelectedTitle"].Value"
                            show-all-items-title="@Localizer["PickerShowAllItemsTitle"].Value"
                            item-already-selected-title="@Localizer["PickerItemAlreadySelectedTitle"].Value">
                    </picker>
                </div>
            </div>

            <!--Select with tags-->
			<div class="form-group row">
				<label asp-for="Scopes" class="col-sm-3 col-form-label">
					@await Html.PartialAsync("ApiResource/Section/Label", "Scopes")
				</label>
				<div class="col-sm-9">
					<picker id="ScopesItems" multiple-select="true" min-search-text="2"
							selected-items="@Model.Scopes" url="@Url.Action("SearchApiScopes","Configuration")?scope"
							search-input-placeholder="@Localizer["PickerSearchItemPlaceholder"].Value"
							selected-items-title="@Localizer["PickerSelectedItemsTitle"].Value"
							search-result-title="@Localizer["PickerSearchResultTitle"].Value"
							suggested-items-title="@Localizer["PickerSuggestedItemsTitle"].Value"
							no-item-selected-title="@Localizer["PickerNoItemSelectedTitle"].Value"
							show-all-items-title="@Localizer["PickerShowAllItemsTitle"].Value"
							item-already-selected-title="@Localizer["PickerItemAlreadySelectedTitle"].Value">
					</picker>
				</div>
			</div>

			<!--Button-->
			<div class="form-group row">
				<label class="col-sm-3 col-form-label">
				</label>
				<div class="col-sm-9">
					<button type="submit" id="api-resource-save-button" class="btn btn-primary">@Localizer["ButtonSaveApiResource"]</button>
					@if (Model.Id != 0)
					{
						<a asp-area="@CommonConsts.AdminUIArea" class="btn btn-danger" asp-action="ApiResourceDelete" asp-route-id="@Model.Id">@Localizer["ButtonDeleteApiResource"]</a>
					}
				</div>
			</div>
		</div>
	</div>

</form>

@section scripts
	{
    <script>
		$(function () {
			//Disable enter for this form
			FormMvc.disableEnter($('#api-resource-form'));
		});
		
		ko.bindingHandlers.modal = {
    init: function (element, valueAccessor) {
        $(element).modal({
            show: false
        });

        var value = valueAccessor();
        if (ko.isObservable(value)) {
            $(element).on('hidden.bs.modal', function () {
                value(false);
            });
        }

    },
    update: function (element, valueAccessor) {
        var value = valueAccessor();
        if (ko.utils.unwrapObservable(value)) {
            $(element).modal('show');
        } else {
            $(element).modal('hide');
        }
    }
    }

ko.components.register('picker', {
    viewModel: function (params) {

        var self = this;

        //Constants
        const minSearchSelectConst = 2;
        const inputSearchDelay = 500;
        const topSuggestedItemsConst = 5;

        //Input
        this.textTerm = ko.observable("").extend({ rateLimit: inputSearchDelay });
        this.minSearchText = ko.observable(params.minSearchText || minSearchSelectConst);
        this.multipleSelect = ko.observable(params.multipleSelect || false);

        //Labels
        this.searchInputPlaceholder = ko.observable(params.searchInputPlaceholder || `Enter ${this.minSearchText()} or more characters`);
        this.selectedItemsTitle = ko.observable(params.selectedItemsTitle || "Selected: ");
        this.searchResultTitle = ko.observable(params.searchResultTitle || "Search result: ");
        this.suggestedItemsTitle = ko.observable(params.suggestedItemsTitle || "Suggested items: ");

        this.noItemSelectedTitle = ko.observable(params.noItemSelectedTitle || "No item/s selected");
        this.showAllItemsTitle = ko.observable(params.showAllItemsTitle || "more");
        this.allowSuggestedItems = ko.observable((params.allowSuggestedItems && params.url) || false);
        this.topSuggestedItems = ko.observable(params.topSuggestedItems || topSuggestedItemsConst);
        this.allowItemAlreadySelectedNotification = ko.observable(params.allowItemAlreadySelectedNotification || true);
        this.itemAlreadySelectedTitle = ko.observable(params.itemAlreadySelectedTitle || "item already selected");

        //Collections
        this.searchResult = ko.observableArray([]);
        this.selectedResult = ko.observableArray(params.selectedItems || []);
        this.suggestedResult = ko.observableArray([]);

        //Features
        this.loading = ko.observable(false);

        //Setup values for editing mode
        //Value for dialog
        this.isVisibleEditDialog = ko.observable(false);

        //In this value will be stored new value during editing mode
        this.editedItem = ko.observable("");

        //In this value will be stored original value during editing mode
        this.editedItemOriginal = ko.observable("");

        //Sync selected items to hiddenField for server-side
        const selectedItems = ko.toJSON(this.selectedResult);
        if (this.multipleSelect() === true) {
            if (this.selectedResult().length === 0) {
                $(`#${params.hiddenId}`).val("");
            } else {
                $(`#${params.hiddenId}`).val(selectedItems);
            }
        } else {
            if (this.selectedResult().length === 0) {
                $(`#${params.hiddenId}`).val("");
            } else {
                $(`#${params.hiddenId}`).val(this.selectedResult()[0]);
            }
        }

        //Track changes on search input
        this.textTerm.subscribe(function (searchTerm) {

            //If is search input clear -> clear search result
            if (searchTerm.trim() === "") {
                self.searchResult([]);
            }

            //If search term isn't empty and has min length characters
            if (searchTerm.trim() !== "" && searchTerm.trim().length >= self.minSearchText()) {

                if (params.url) {
                    //start loading
                    self.loading(true);

                    //make ajax request and result add to search result
                    $.get(`${params.url}=${searchTerm}`,
                        function (data) {

                            if (data.indexOf(searchTerm) === -1) {
                                data.push(searchTerm);
                            }

                            self.searchResult(data);

                            //stop loading
                            self.loading(false);
                        });
                } else {
                    self.searchResult([searchTerm]);
                }
            }
        });

        this.notify = function (item) {
            toastr.options.closeButton = true;
            toastr.options.preventDuplicates = true;
            toastr.info(`${item} ${this.itemAlreadySelectedTitle()}`);
        }

        this.notifyError = function (error) {
            toastr.options.closeButton = true;
            toastr.options.preventDuplicates = true;
            toastr.error(error);
        }

        //Action methods
        this.add = function (item) {

            //Replace quotes
            item = item.replace(/'/g, "").replace(/"/g, "");

            //Check if selected item is exists in selected items array
            if (this.selectedResult.indexOf(item) > -1) {

                if (this.allowItemAlreadySelectedNotification() === true) {
                    this.notify(item);
                }

                return;
            }

            //Single select -> the original value replace with new
            if (this.multipleSelect() === false) {
                this.selectedResult([]);
                this.selectedResult.push(item);
                this.clear();
                this.sync();
            }
            //Multiple select
            else if (this.multipleSelect() === true) {
                this.selectedResult.push(item);
                this.clear();
                this.sync();
            }
        }

        //Get suggested items - by default 5 items
        this.getSuggestedItems = function () {

            if (self.allowSuggestedItems() === false) return;

            if (params.url) {
                //start loading
                self.loading(true);

                //make ajax request and result add to suggested result
                $.get(params.url,
                    {
                        limit: self.topSuggestedItems()
                    },
                    function (data) {

                        self.suggestedResult(data);

                        //stop loading
                        self.loading(false);
                    });
            }
        }

        //Clear search input and search result
        this.clear = function () {
            this.textTerm("");
            self.searchResult([]);
        }

        //Show dialog for editing items
        this.showEditDialog = function (item) {
            //Setup value for showing the dialog
            self.isVisibleEditDialog(true);

            //Setup values for editing
            self.editedItem(item);
            self.editedItemOriginal(item);
        }

        //Save item after editing
        this.submitEditDialog = function () {

            //If is editing item empty
            if (self.editedItem().trim() === "") {
                return;
            }

            //If item already exists show error message
            if (self.checkIfItemExists(self.editedItemOriginal().trim(), self.editedItem().trim())) {
                self.notifyError(`${self.editedItem().trim()} ${this.itemAlreadySelectedTitle()}`);
                return;
            }

            //Update old value with new one
            self.update(self.editedItemOriginal().trim(), self.editedItem().trim());

            //Hide the dialog for editing
            self.isVisibleEditDialog(false);
        }

        //Check if item which is editing is already selected
        this.checkIfItemExists = function (item, newValue) {

            //The original item is same like new item
            if (item.trim() === newValue.trim()) {
                return false;
            }

            //Item is already selected
            if (this.selectedResult.indexOf(newValue) > -1) {
                return true;
            }

            return false;
        }

        //Update selected result
        this.update = function (item, newValue) {

            for (var i = 0; i < self.selectedResult().length; i++) {
                if (self.selectedResult()[i] === item) {
                    self.selectedResult()[i] = newValue;
                    self.selectedResult.valueHasMutated();
                    break;
                }
            }

            self.sync();
        }

        //Remove selected item
        this.remove = function (item) {
            this.selectedResult.remove(item);
            this.sync();
        }

        //Show all items into suggested items
        this.showAll = function () {

            if (params.url) {
                //start loading
                self.loading(true);

                //make ajax request and result add to search result
                $.get(`${params.url}`,
                    function (data) {

                        self.suggestedResult(data);

                        //stop loading
                        self.loading(false);
                    });
            }
        }

        //Synchronize the selected items to hidden field for server-side part
        this.sync = function () {
            const selectedItems = ko.toJSON(this.selectedResult);
            if (this.multipleSelect() === true) {
                if (this.selectedResult().length === 0) {
                    $(`#${params.hiddenId}`).val("");
                } else {
                    $(`#${params.hiddenId}`).val(selectedItems);
                }
            } else {
                if (this.selectedResult().length === 0) {
                    $(`#${params.hiddenId}`).val("");
                } else {
                    $(`#${params.hiddenId}`).val(this.selectedResult()[0]);
                }
            }
        }

        //Load suggested items
        self.getSuggestedItems();
    },
    template: '<div class="card">' +
        '<div class="card-body">' +
        '<input class="form-control" data-bind="textInput: textTerm, attr: {placeholder: searchInputPlaceholder}" />' +
        '<hr data-bind="visible: searchResult().length > 0" />' +
        '<div data-bind="visible: searchResult().length > 0, text: searchResultTitle" class="search-title"></div>' +
        '<div class="block__buttons__add" data-bind="foreach: searchResult"><input type="button" class="btn btn-primary button__add" data-bind="value: $data, click: function() { $parent.add($data); }"></div>' +
        '<img data-bind="visible: loading()" src="/images/loading.gif" alt="Loading.." />' +
        '<hr />' +
        '<div data-bind="visible: selectedResult().length == 0, text: noItemSelectedTitle" class="search-title"></div>' +
        '<div data-bind="visible: selectedResult().length > 0, text: selectedItemsTitle" class="search-title"></div>' +
        '<div class="row" data-bind="foreach: selectedResult">' +
        '<div class="col-12">' +
        '<span class="button__text border-primary" data-bind="text: $data"></span>' +
        '<button class="btn btn-outline-primary button__update" data-bind="click: function() { $parent.showEditDialog($data) }"><span class="oi oi-pencil"></span></button>' +
        '<button class="btn btn-outline-primary button__delete" data-bind="click: function() { $parent.remove($data); }"><span class="oi oi-x"></span></button>' +
        '</div>' +
        '</div>' +
        '<hr data-bind="visible: suggestedResult().length > 0" />' +
        '<div data-bind="visible: suggestedResult().length > 0, text: suggestedItemsTitle" class="search-title"></div>' +
        '<!-- ko foreach: suggestedResult -->' +
        '<input type="button" class="btn btn-light button__add" data-bind="value: $data, click: function() { $parent.add($data); }">' +
        '<!-- /ko -->' +
        '<button class="btn btn-secondary button__show-all" data-bind="visible:allowSuggestedItems(), click: function() { $component.showAll(); }"><span data-bind="text: showAllItemsTitle"></span> <span class="oi oi-plus"></span></button>' +
        '</div>' +
        '</div>' +
        '<div class="modal fade" tabindex="-1" role="dialog" data-bind="modal:isVisibleEditDialog">' +
        '<div class="modal-dialog">' +
        '<div class="modal-content"> ' +
        '<div class="modal-header">' +
        '<h5 data-bind="text: editedItemOriginal" class="modal-title"></h5>' +
        '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<input class="form-control" type="hidden" data-bind="value: editedItemOriginal" />' +
        '<input class="form-control" type="text" data-bind="value: editedItem" />' +
        '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-primary btn-xs" data-bind="click: submitEditDialog">OK</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>'
});

ko.applyBindings();


	</script>
}